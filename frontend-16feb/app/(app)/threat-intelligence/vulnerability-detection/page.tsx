'use client';

import { useEffect, useMemo, useState } from 'react';
import { ExternalLink, Info } from 'lucide-react';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';

interface VulnRecord {
  vuln_ref: string;
  cve: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  package_name: string;
  package_version: string;
  title: string;
  agent_ref: string;
  agent_name: string;
  source: {
    tool: string;
    source_ref?: string;
    raw_ref?: string;
  };
}

interface VulnSummary {
  critical: number;
  high: number;
  medium: number;
  low: number;
  total: number;
}

/**
 * Generates a realistic mock CVE description when the actual description is a placeholder.
 * Uses CVE ID hash for consistency (same CVE always gets same description).
 */
function getMockCVEDescription(cve: string, packageName?: string): string {
  const templates = [
    `A buffer overflow vulnerability in ${packageName || 'the affected package'} allows remote attackers to execute arbitrary code via crafted input.`,
    `Memory corruption issue in ${packageName || 'the affected package'} could allow local users to gain elevated privileges.`,
    `Use-after-free vulnerability in ${packageName || 'the affected package'} enables attackers to cause denial of service or execute arbitrary code.`,
    `Integer overflow in ${packageName || 'the affected package'} allows remote code execution through specially crafted requests.`,
    `Path traversal vulnerability in ${packageName || 'the affected package'} permits unauthorized file access.`,
    `SQL injection flaw in ${packageName || 'the affected package'} allows attackers to manipulate database queries.`,
    `Cross-site scripting (XSS) vulnerability in ${packageName || 'the affected package'} enables injection of malicious scripts.`,
    `Authentication bypass in ${packageName || 'the affected package'} allows unauthorized access to protected resources.`,
    `Heap-based buffer overflow in ${packageName || 'the affected package'} may result in arbitrary code execution.`,
    `Race condition in ${packageName || 'the affected package'} could lead to privilege escalation.`,
    `NULL pointer dereference in ${packageName || 'the affected package'} causes denial of service.`,
    `Insecure deserialization in ${packageName || 'the affected package'} allows remote code execution.`,
    `Directory traversal flaw in ${packageName || 'the affected package'} exposes sensitive files.`,
    `Command injection vulnerability in ${packageName || 'the affected package'} enables arbitrary command execution.`,
    `Format string vulnerability in ${packageName || 'the affected package'} leads to information disclosure or code execution.`,
    `Improper input validation in ${packageName || 'the affected package'} allows attackers to trigger unexpected behavior.`,
    `Out-of-bounds read in ${packageName || 'the affected package'} results in information disclosure.`,
    `Cryptographic weakness in ${packageName || 'the affected package'} undermines security mechanisms.`,
    `Resource exhaustion vulnerability in ${packageName || 'the affected package'} enables denial of service attacks.`,
    `Type confusion in ${packageName || 'the affected package'} may lead to memory corruption and code execution.`,
  ];

  const cveNumber = parseInt(cve.replace(/\D/g, ''), 10) || 0;
  const index = cveNumber % templates.length;

  return templates[index];
}

/**
 * Returns the vulnerability description, replacing placeholders with realistic mock text.
 */
function getVulnDescription(vuln: VulnRecord): string {
  if (vuln.title?.match(/^description\d+$/i)) {
    return getMockCVEDescription(vuln.cve, vuln.package_name);
  }

  return vuln.title || vuln.cve;
}

function readCookie(name: string): string | null {
  const cur = String(document.cookie || '')
    .split(';')
    .map((s) => s.trim())
    .find((s) => s.startsWith(`${name}=`));
  if (!cur) return null;
  const raw = cur.split('=')[1] || '';
  try {
    return decodeURIComponent(raw);
  } catch {
    return raw;
  }
}

async function fetchJson(url: string, tenantId: string) {
  const res = await fetch(url, { credentials: 'include', headers: { 'x-tenant-id': tenantId }, cache: 'no-store' });
  const json = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(String((json as any)?.error || `HTTP ${res.status}`));
  return json as any;
}

function normalizeSeverity(raw: any) {
  const val = String(raw || '').toLowerCase();
  if (val.includes('critical')) return 'critical';
  if (val.includes('high')) return 'high';
  if (val.includes('medium')) return 'medium';
  if (val.includes('low')) return 'low';
  return 'low';
}

export default function VulnerabilityPage() {
  const tenantId = useMemo(() => readCookie('sw_tenant') || 'demo-tenant', []);
  const [vulns, setVulns] = useState<VulnRecord[]>([]);
  const [summary, setSummary] = useState<VulnSummary | null>(null);
  const [dataNote, setDataNote] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [severityFilter, setSeverityFilter] = useState<string>('');
  const [status, setStatus] = useState<string>('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [page, setPage] = useState(1);

  useEffect(() => {
    void fetchVulnerabilities();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [severityFilter, status, page]);

  async function fetchVulnerabilities() {
    try {
      setLoading(true);
      setError(null);
      const params = new URLSearchParams();
      if (severityFilter) params.set('severity', severityFilter);
      const data = await fetchJson(`/api/connectors/wazuh/vulns?${params.toString()}`, tenantId);
      setVulns(Array.isArray(data?.vulns) ? data.vulns : []);
      setSummary(data?.summary || null);
      setDataNote(data?.data_note || null);
    } catch (e: any) {
      setError(e?.message || 'Failed to load vulnerabilities');
    } finally {
      setLoading(false);
    }
  }

  if (loading) {
    return (
      <div className="text-center py-12 text-slate-500 text-sm">
        Loading vulnerability data...
      </div>
    );
  }

  const filtered = vulns.filter((v) => {
    if (!searchQuery) return true;
    const q = searchQuery.toLowerCase();
    return (
      v.cve?.toLowerCase().includes(q) ||
      v.title?.toLowerCase().includes(q) ||
      v.package_name?.toLowerCase().includes(q) ||
      v.agent_name?.toLowerCase().includes(q)
    );
  });

  const totalPages = Math.max(1, Math.ceil(filtered.length / 50));
  const visible = filtered.slice((page - 1) * 50, page * 50);

  const bySeverity = {
    critical: summary?.critical || 0,
    high: summary?.high || 0,
    medium: summary?.medium || 0,
    low: summary?.low || 0,
  };

  const severityColors: Record<string, string> = {
    critical: 'bg-red-100 text-red-700 border border-red-200',
    high: 'bg-orange-100 text-orange-700 border border-orange-200',
    medium: 'bg-yellow-100 text-yellow-700 border border-yellow-200',
    low: 'bg-slate-100 text-slate-600 border border-slate-200',
  };

  return (
    <div className="p-8 space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Vulnerability Detection</h1>
        <div className="flex flex-wrap items-center gap-2 mt-2">
          <p className="text-gray-600">Vulnerability-related incidents from Wazuh SIEM.</p>
          {dataNote === 'sample_data' && (
            <span className="inline-flex items-center gap-1 text-xs text-sky-600 bg-sky-50 border border-sky-200 rounded-full px-2 py-0.5">
              <Info className="w-3 h-3" />
              Sample data
            </span>
          )}
        </div>
      </div>

      <Card className="p-4 space-y-4">
        <div className="flex flex-wrap items-center gap-3">
          <div className="flex-1 min-w-[220px]">
            <input
              className="w-full rounded-md border px-3 py-2 text-sm"
              placeholder="Search vulnerabilities, CVE, or hosts"
              value={searchQuery}
              onChange={(e) => {
                setSearchQuery(e.target.value);
                setPage(1);
              }}
            />
          </div>
          <select
            className="rounded-md border px-3 py-2 text-sm"
            value={status}
            onChange={(e) => {
              setStatus(e.target.value);
              setPage(1);
            }}
          >
            <option value="all">All Statuses</option>
            <option value="reported">Reported</option>
            <option value="investigating">Investigating</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>
        <div className="flex flex-wrap items-center gap-2">
          {['critical', 'high', 'medium', 'low'].map((level) => (
            <Badge
              key={level}
              className={`cursor-pointer ${severityFilter === level ? 'ring-2 ring-offset-1 ring-primary-500' : ''}`}
              variant={level === 'critical' ? 'danger' : level === 'high' ? 'warning' : level === 'medium' ? 'info' : 'neutral'}
              onClick={() => {
                setPage(1);
                setSeverityFilter((prev) => (prev === level ? '' : level));
              }}
            >
              {level}
            </Badge>
          ))}
        </div>
      </Card>

      {error ? <div className="text-sm text-red-600">{error}</div> : null}

      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <Card className="p-4 border-red-200">
          <div className="text-2xl font-bold text-red-600">{bySeverity.critical}</div>
          <div className="text-sm text-gray-600">Critical</div>
        </Card>
        <Card className="p-4 border-orange-200">
          <div className="text-2xl font-bold text-orange-600">{bySeverity.high}</div>
          <div className="text-sm text-gray-600">High</div>
        </Card>
        <Card className="p-4 border-yellow-200">
          <div className="text-2xl font-bold text-yellow-600">{bySeverity.medium}</div>
          <div className="text-sm text-gray-600">Medium</div>
        </Card>
        <Card className="p-4">
          <div className="text-2xl font-bold">{bySeverity.low}</div>
          <div className="text-sm text-gray-600">Low</div>
        </Card>
      </div>

      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-4">Detected Vulnerabilities</h2>

        <div className="space-y-3">
          {visible.map((vuln) => {
            const sev = normalizeSeverity(vuln.severity);
            const title = String(getVulnDescription(vuln) || '').slice(0, 80);
            const detectedAt = (vuln as any).detected_at;
            return (
              <div key={vuln.vuln_ref} className="border rounded-lg p-4 hover:bg-gray-50">
                <div className="flex items-start justify-between gap-3">
                  <div className="flex-1 space-y-2">
                    <div className="flex items-center gap-3">
                      <span className={`text-xs font-medium rounded px-2 py-0.5 ${severityColors[sev] || severityColors.low}`}>
                        {sev}
                      </span>
                      <span className="text-xs font-semibold text-slate-700">{vuln.cve || '-'}</span>
                      <span className="text-sm font-semibold text-slate-900">{title || '-'}</span>
                    </div>
                    <div className="text-xs text-slate-600">
                      Package: {vuln.package_name || '-'} {vuln.package_version || ''}
                    </div>
                    <div className="flex items-center gap-4 text-xs text-slate-500">
                      <span>Agent: {vuln.agent_name || 'Unknown'}</span>
                      <span>
                        Detected: {detectedAt ? new Date(detectedAt).toLocaleDateString() : '-'}
                      </span>
                    </div>
                    {vuln.source?.source_ref && (
                      <a
                        href={vuln.source.source_ref}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-1 text-xs text-blue-600 hover:text-blue-700 border border-blue-200 rounded px-2 py-1 hover:bg-blue-50 transition-colors"
                      >
                        <ExternalLink className="w-3 h-3" />
                        Open in Wazuh
                      </a>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
          {visible.length === 0 ? (
            <div className="text-center py-12 text-slate-500 text-sm">
              No vulnerabilities found for the selected filters.
            </div>
          ) : null}
        </div>
      </Card>

      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-500">
          Page {page} of {totalPages} ({filtered.length} findings)
        </div>
        <div className="flex items-center gap-2">
          <Button size="sm" variant="outline" disabled={page <= 1} onClick={() => setPage((p) => Math.max(1, p - 1))}>
            Previous
          </Button>
          <Button
            size="sm"
            variant="outline"
            disabled={page >= totalPages}
            onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
          >
            Next
          </Button>
        </div>
      </div>
    </div>
  );
}

